#!/usr/bin/env bash
#
# viberunner HR check script
# Verifies HR signal is valid before allowing Claude Code tool execution
#
# Exit codes:
#   0 - HR OK, tools unlocked
#   2 - HR check failed, tools locked (Claude Code PreToolUse block code)
#

set -e

CONFIG_FILE="viberunner.config.json"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"

# Check for required tools
command -v jq >/dev/null 2>&1 || { echo "viberunner: jq not installed — tools locked" >&2; exit 2; }
command -v openssl >/dev/null 2>&1 || { echo "viberunner: openssl not installed — tools locked" >&2; exit 2; }
command -v xxd >/dev/null 2>&1 || { echo "viberunner: xxd not installed — tools locked" >&2; exit 2; }

# Read config
if [[ ! -f "$REPO_ROOT/$CONFIG_FILE" ]]; then
  echo "viberunner: config not found — tools locked" >&2
  exit 2
fi

USER_KEY=$(jq -r '.user_key' "$REPO_ROOT/$CONFIG_FILE")
PUBLIC_KEY=$(jq -r '.public_key' "$REPO_ROOT/$CONFIG_FILE")
TTL_SECONDS=$(jq -r '.ttl_seconds' "$REPO_ROOT/$CONFIG_FILE")
SIGNAL_REF="refs/viberunner/hr/$USER_KEY"

# Validate config values
if [[ -z "$USER_KEY" || "$USER_KEY" == "null" ]]; then
  echo "viberunner: invalid user_key in config — tools locked" >&2
  exit 2
fi

if [[ -z "$PUBLIC_KEY" || "$PUBLIC_KEY" == "null" ]]; then
  echo "viberunner: invalid public_key in config — tools locked" >&2
  exit 2
fi

# Fetch the signal ref from origin
TEMP_REF="refs/viberunner-check/hr-signal"
if ! git fetch origin "$SIGNAL_REF:$TEMP_REF" --quiet 2>/dev/null; then
  echo "viberunner: HR signal not found (fetch failed) — tools locked" >&2
  exit 2
fi

# Read payload from the ref
PAYLOAD=$(git show "$TEMP_REF:hr-signal.json" 2>/dev/null)
if [[ -z "$PAYLOAD" ]]; then
  echo "viberunner: HR payload missing — tools locked" >&2
  exit 2
fi

# Clean up temp ref
git update-ref -d "$TEMP_REF" 2>/dev/null || true

# Extract fields from payload
V=$(echo "$PAYLOAD" | jq -r '.v')
PAYLOAD_USER_KEY=$(echo "$PAYLOAD" | jq -r '.user_key')
SESSION_ID=$(echo "$PAYLOAD" | jq -r '.session_id')
HR_OK=$(echo "$PAYLOAD" | jq -r '.hr_ok')
BPM=$(echo "$PAYLOAD" | jq -r '.bpm')
THRESHOLD_BPM=$(echo "$PAYLOAD" | jq -r '.threshold_bpm')
EXP_UNIX=$(echo "$PAYLOAD" | jq -r '.exp_unix')
NONCE=$(echo "$PAYLOAD" | jq -r '.nonce')
SIG=$(echo "$PAYLOAD" | jq -r '.sig')

# Validate payload structure
if [[ "$V" == "null" || "$PAYLOAD_USER_KEY" == "null" || "$SESSION_ID" == "null" || \
      "$HR_OK" == "null" || "$BPM" == "null" || "$THRESHOLD_BPM" == "null" || \
      "$EXP_UNIX" == "null" || "$NONCE" == "null" || "$SIG" == "null" ]]; then
  echo "viberunner: malformed payload — tools locked" >&2
  exit 2
fi

# Validate user_key matches
if [[ "$PAYLOAD_USER_KEY" != "$USER_KEY" ]]; then
  echo "viberunner: user_key mismatch — tools locked" >&2
  exit 2
fi

# Check expiration
NOW=$(date +%s)
if [[ "$EXP_UNIX" -le "$NOW" ]]; then
  EXPIRED_AGO=$((NOW - EXP_UNIX))
  echo "viberunner: HR signal expired ${EXPIRED_AGO}s ago — tools locked" >&2
  exit 2
fi

# Build canonical payload for signature verification (alphabetical keys)
CANONICAL=$(echo "$PAYLOAD" | jq -cS '{bpm,exp_unix,hr_ok,nonce,session_id,threshold_bpm,user_key,v}')

# Create temporary files for signature verification
SIG_BIN=$(mktemp)
PUB_KEY_BIN=$(mktemp)
PUB_KEY_PEM=$(mktemp)
MSG_FILE=$(mktemp)

# Cleanup function
cleanup() {
  rm -f "$SIG_BIN" "$PUB_KEY_BIN" "$PUB_KEY_PEM" "$MSG_FILE"
}
trap cleanup EXIT

# Convert hex signature to binary
echo -n "$SIG" | xxd -r -p > "$SIG_BIN"

# Convert hex public key to binary
echo -n "$PUBLIC_KEY" | xxd -r -p > "$PUB_KEY_BIN"

# Create PEM formatted Ed25519 public key
# OID prefix for Ed25519: 302a300506032b6570032100
{
  echo "-----BEGIN PUBLIC KEY-----"
  (echo -n "302a300506032b6570032100"; cat "$PUB_KEY_BIN" | xxd -p -c 32) | xxd -r -p | base64
  echo "-----END PUBLIC KEY-----"
} > "$PUB_KEY_PEM"

# Write message to file
echo -n "$CANONICAL" > "$MSG_FILE"

# Verify Ed25519 signature
if ! openssl pkeyutl -verify -pubin -inkey "$PUB_KEY_PEM" -sigfile "$SIG_BIN" -in "$MSG_FILE" -rawin 2>/dev/null; then
  echo "viberunner: invalid signature — tools locked" >&2
  exit 2
fi

# Check hr_ok flag
if [[ "$HR_OK" != "true" ]]; then
  echo "viberunner: HR $BPM below threshold $THRESHOLD_BPM — tools locked" >&2
  exit 2
fi

# All checks passed - output session info for commit tagging
# Claude can parse this to extract session_id for [vr:SESSION_ID] tags
echo "viberunner: HR $BPM ✓ — session_id=$SESSION_ID"
exit 0
